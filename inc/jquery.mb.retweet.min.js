/*******************************************************************************
 jquery.mb.components
 Copyright (c) 2001-2010. Matteo Bicocchi (Pupunzi); Open lab srl, Firenze - Italy
 email: info@pupunzi.com
 site: http://pupunzi.com

 Licences: MIT, GPL
 http://www.opensource.org/licenses/mit-license.php
 http://www.gnu.org/licenses/gpl.html
 ******************************************************************************/

/*
 * jQuery.mb.components: jquery.mb.retweet
 * version: 1.0- 14-nov-2009 - 10
 * Â© 2001 - 2009 Matteo Bicocchi (pupunzi), Open Lab
 *
 */

(function(a){a.mbRetweet={name:"mb.retweet",author:"Matteo Bicocchi",version:"1.0",BitlyAPIversion:"2.0.1",user:"patapage",key:"R_65320846dbaf9103bdb23631255a0f9e",defaults:{label:"Retweet",prefix:"RT @pupunzi ",color:"#32CCFF",commentPanel:true},mbBitlyShorten:function(){var c=a(this).get(0),b="http://api.bit.ly/shorten?version="+a.mbRetweet.BitlyAPIversion+"&longUrl="+encodeURIComponent(c.url)+"&login="+a.mbRetweet.user+"&apiKey="+a.mbRetweet.key;a.ajax({url:b,dataType:"jsonp",success:function(d){for(var e in d.results)c.shortUrl= d.results[e].shortUrl},error:function(d,e){alert(e)}})},mbBitlyStats:function(){var c=a(this).get(0),b="http://api.bit.ly/stats?version="+a.mbRetweet.BitlyAPIversion+"&shortUrl="+c.shortUrl+"&login="+a.mbRetweet.user+"&apiKey="+a.mbRetweet.key;a.ajax({url:b,dataType:"jsonp",success:function(d){c.stats=d.results.clicks},error:function(d,e){alert(e)}})},buildMbRetweet:function(c){return this.each(function(){this.options={};a.extend(this.options,a.mbRetweet.defaults,c);this.url=a(this).hasClass("self")? self.location.href:a(this).attr("href");this.desc=a(this).text();this.desc=this.desc.length>=90?this.desc.substring(0,100)+"...":this.desc;var b=this;a(this).html(this.options.label);a(this).wrap("<span style='position:relative;width:160px'/>");if(a.mbRetweet.user){a(this).mbBitlyShorten();var d=setInterval(function(){if(typeof b.shortUrl!=="undefined"){clearInterval(d);a(b).wrapInner("<span class='mbretweetLabel'/>");a(b).find(".mbretweetLabel").css("background-color",b.options.color).hover(function(){a(this).css("opacity", 0.7);clearTimeout(b.removeExtra)},function(){a(this).css("opacity","");b.removeExtra=setTimeout(function(){a(b).removeMbRetweetExtra()},1000)});a(b).find(".mbretweetLabel").one("click",function(){if(a("#mbretweetDesc").length>0)b.desc=a("#mbretweetDesc").val();var f="http://twitter.com/home?status="+encodeURIComponent(b.options.prefix+" "+b.desc+": "+b.shortUrl);window.open(f,"twitter");a(".mbretweetExtra").remove();a(b).addClass("disabled")});if(b.options.commentPanel){a(b).find(".mbretweetLabel").append("<span class='mbopenExtra'>&#9660;</span>"); a(b).find(".mbopenExtra").click(function(){a(".mbretweetExtra").remove();setTimeout(function(){a(b).buildMbRetweetExtra()},250);return false})}a(b).attr("href","javascript:void(0)");a(b).mbBitlyStats();var e=setInterval(function(){if(typeof b.stats!=="undefined"){clearInterval(e);a(b).append("<span class='mbretweetStats'>"+b.stats+"</span>")}},10)}},10)}else{a(b).wrapInner("<span class='mbretweetLabel'/>");a(b).find(".mbretweetLabel").css("background-color",b.options.color).hover(function(){clearTimeout(b.removeExtra)}, function(){b.removeExtra=setTimeout(function(){a(b).removeMbRetweetExtra()},500)});a(b).find(".mbretweetLabel").one("click",function(){if(a("#mbretweetDesc").length>0)b.desc=a("#mbretweetDesc").val();var e="http://twitter.com/home?status="+encodeURIComponent(b.options.prefix+" "+b.desc+": "+b.url);window.open(e,"twitter");a(".mbretweetExtra").fadeOut(200,function(){});a(b).addClass("disabled")});a(b).attr("href","javascript:void(0)");if(b.options.commentPanel){a(b).find(".mbretweetLabel").append("<span class='mbopenExtra'>&#9660;</span>"); a(b).find(".mbopenExtra").click(function(){a(".mbretweetExtra").remove();setTimeout(function(){a(b).buildMbRetweetExtra()},250);return false})}}})},buildMbRetweetExtra:function(){var c=a(this).get(0),b=a.mbRetweet.user?c.shortUrl:c.url;clearTimeout(c.removeExtra);if(!a(this).hasClass("disabled")){var d=a("<div class='mbretweetExtra'></div>").hide();d.css({left:0,top:14});d.append("add a comment:<br><textarea maxlength='140' id='mbretweetDesc' >"+c.desc+"</textarea>");a(this).css({position:"relative"}); a(this).after(d);d.fadeIn();a("#mbretweetDesc").css({color:c.options.color}).focus();a(".mbretweetExtra").bind("mouseenter",function(){clearTimeout(c.removeExtra)}).bind("mouseleave",function(){c.removeExtra=setTimeout(function(){a(c).removeMbRetweetExtra()},500)});d.keypress(function(e){e.which==13&&a(c).find(".mbretweetLabel").click();e=140-a("#mbretweetDesc").val().length-c.options.prefix.length-b.length;a(".mbretweetExtra").find("#mbcounter").html(e+" left &nbsp;&nbsp;");e<0?a(".mbretweetExtra").find("#mbcounter").addClass("alert"): a(".mbretweetExtra").find("#mbcounter").removeClass("alert")});a("#mbretweetDesc").after("<div class='extraretweet' style='text-align:right'><span id='mbcounter'>"+(140-c.desc.length-c.options.prefix.length-b.length)+" left &nbsp;&nbsp;</span><span class='goretweet'>retweet!</span></div>");a(".goretweet").css({color:"white",backgroundColor:c.options.color}).click(function(){a(c).find(".mbretweetLabel").click()})}},removeMbRetweetExtra:function(){a(".mbretweetExtra").remove()}};a.fn.buildMbRetweet= a.mbRetweet.buildMbRetweet;a.fn.buildMbRetweetExtra=a.mbRetweet.buildMbRetweetExtra;a.fn.removeMbRetweetExtra=a.mbRetweet.removeMbRetweetExtra;a.fn.mbBitlyShorten=a.mbRetweet.mbBitlyShorten;a.fn.mbBitlyStats=a.mbRetweet.mbBitlyStats})(jQuery);